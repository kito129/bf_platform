<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>betfairplatform documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css" media="(prefers-color-scheme: dark)">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">betfairplatform documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content interface">
                   <div class="content-data">












<ol class="breadcrumb">
  <li>Interfaces</li>
  <li
  >
  RunnerDataAdvanced</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/app/shared/charts/tradingView-charts/advanced-multiple-selections/tv-advanced-multiple-selections.component.ts</code>
        </p>




        <section>
            <h3 id="index">Index</h3>
            <table class="table table-sm table-bordered index-table">
                <tbody>
                    <tr>
                        <td class="col-md-4">
                            <h6><b>Properties</b></h6>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <ul class="index-list">
                                <li>
                                        <a href="#color"
>
                                            color
                                        </a>
                                </li>
                                <li>
                                        <a href="#data"
>
                                            data
                                        </a>
                                </li>
                                <li>
                                        <a href="#name"
>
                                            name
                                        </a>
                                </li>
                                <li>
                                        <a href="#runnerId"
>
                                            runnerId
                                        </a>
                                </li>
                                <li>
                                        <a href="#visible"
>
                                            visible
                                        </a>
                                </li>
                                <li>
                                        <a href="#volume"
>
                                            volume
                                        </a>
                                </li>
                            </ul>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>



            <section>
                <h3 id="inputs">Properties</h3>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="color"></a>
                                        <span class="name "><b>color</b>
                                            <a href="#color">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>color:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="data"></a>
                                        <span class="name "><b>data</b>
                                            <a href="#data">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>data:     <code>any[]</code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code>any[]</code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="name"></a>
                                        <span class="name "><b>name</b>
                                            <a href="#name">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>name:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="runnerId"></a>
                                        <span class="name "><b>runnerId</b>
                                            <a href="#runnerId">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>runnerId:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="visible"></a>
                                        <span class="name "><b>visible</b>
                                            <a href="#visible">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>visible:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="volume"></a>
                                        <span class="name "><b>volume</b>
                                            <a href="#volume">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>volume:     <code>any[]</code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code>any[]</code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
            </section>
    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import {Component, Input, OnDestroy, OnInit} from &#x27;@angular/core&#x27;;
import {DatePipe} from &#x27;@angular/common&#x27;;
import {createChart, LineStyle, PriceScaleMode, CrosshairMode} from &#x27;lightweight-charts&#x27;;
import {MarketDetailAdvanced} from &#x27;../../../../model/advanced/market/marketAdvanced&#x27;;
import {GridData} from &#x27;../../../../model/advanced/gridData&#x27;;
import {LadderData} from &#x27;../../../../model/apxCharts/ladderData&#x27;;
import {Observable, Subject} from &#x27;rxjs&#x27;;


export interface RunnerDataAdvanced{
  runnerId: string,
  data: any[],
  volume: any[],
  color: string,
  name: string,
  visible: boolean
}

@Component({
  selector: &#x27;app-advanced-multiple-selections&#x27;,
  templateUrl: &#x27;./tv-advanced-multiple-selections.component.html&#x27;,
  styles: [&#x60;
    .three-line-legend {
      width: 96px;
      height: 70px;
      position: absolute;
      padding: 8px;
      font-size: 12px;
      background-color: rgba(255, 255, 255, 0.23);
      text-align: left;
      z-index: 1000;
      pointer-events: none;
    }
    &#x60;
  ]
})
export class TvAdvancedMultipleSelectionsComponent implements OnInit, OnDestroy {

  @Input() market: MarketDetailAdvanced

  public runnersData: RunnerDataAdvanced[] &#x3D; [];

  public legend: any

  public clickTime: number

  public byClick: boolean &#x3D; false


  // DATA of the component
  public lineSeriesData: any[] &#x3D; []
  public volumeSeriesData: any[] &#x3D; []
  public candlestickData: any[] &#x3D; []
  private tv: any
  private chart: any


  // TIME FRAME BUTTON
  public timeFrameState &#x3D; []

  collapsedAdvanced &#x3D; true

  // ladder data
  ladder: LadderData &#x3D; new LadderData()
  ladderData: Subject&lt;number[][]&gt; &#x3D; new Subject&lt;number[][]&gt;()

  // for grid
  dataGrid: GridData &#x3D; {
    runnerA: {
      name: &#x27;&#x27;,
      id: 0,
      batb: [],
      batl: [],
    },
    runnerB: {
      name: &#x27;&#x27;,
      id: 0,
      batb: [],
      batl: [],
    }
  }

  constructor(public datePipe: DatePipe) {
    this.ladder.generateLadderArray()
  }


  setInitialGrid(){
    if(this.market.marketSelections.runners.length&gt;&#x3D;2){
      this.dataGrid.runnerA.name &#x3D; this.market.marketSelections.runners[0].name
      this.dataGrid.runnerA.id &#x3D; +this.market.marketSelections.runners[0].id

      this.dataGrid.runnerB.name &#x3D; this.market.marketSelections.runners[1].name
      this.dataGrid.runnerB.id &#x3D; +this.market.marketSelections.runners[1].id

    }
  }

  getBestAvailableByTime(){
    if (this.legend.time &amp;&amp; this.market.marketPrices.odds.length&gt;&#x3D;2){
      // runner A
      const bestAvailableA &#x3D; this.market.marketPrices.odds[0].odds.filter(x &#x3D;&gt; x.timestamp &#x3D;&#x3D;&#x3D; this.legend.time)
      const bestAvailableB &#x3D; this.market.marketPrices.odds[1].odds.filter(x &#x3D;&gt; x.timestamp &#x3D;&#x3D;&#x3D; this.legend.time)
      if(bestAvailableA.length){
        this.dataGrid.runnerA.batb &#x3D; bestAvailableA[0].batb
        this.dataGrid.runnerA.batl &#x3D; bestAvailableA[0].batl
      }
      // runner B
      if(bestAvailableB.length){
        this.dataGrid.runnerB.batb &#x3D; bestAvailableB[0].batb
        this.dataGrid.runnerB.batl &#x3D; bestAvailableB[0].batl
      }

      // remove empty
      this.dataGrid.runnerA.batb &#x3D; this.dataGrid.runnerA.batb ?  this.dataGrid.runnerA.batb.filter( x &#x3D;&gt; x.length): []
      this.dataGrid.runnerA.batl &#x3D; this.dataGrid.runnerA.batl ? this.dataGrid.runnerA.batl.filter( x &#x3D;&gt; x.length): []
      this.dataGrid.runnerB.batb &#x3D; this.dataGrid.runnerB.batb ? this.dataGrid.runnerB.batb.filter( x &#x3D;&gt; x.length): []
      this.dataGrid.runnerB.batl &#x3D; this.dataGrid.runnerB.batl ? this.dataGrid.runnerB.batl.filter( x &#x3D;&gt; x.length): []

      // push to reach size 3
      for(let i&#x3D;0; i&lt;3;i++){
        if(!this.dataGrid.runnerA.batb[i]){
          this.dataGrid.runnerA.batb.push([0,0,0])
        }
        if(!this.dataGrid.runnerA.batl[i]){
          this.dataGrid.runnerA.batl.push([0,0,0])
        }
        if(!this.dataGrid.runnerB.batb[i]){
          this.dataGrid.runnerB.batb.push([0,0,0])
        }
        if(!this.dataGrid.runnerB.batl[i]){
          this.dataGrid.runnerB.batl.push([0,0,0])
        }
      }
      // revers back
      this.dataGrid.runnerA.batb &#x3D; this.dataGrid.runnerA.batb.slice().reverse()
      this.dataGrid.runnerB.batb &#x3D; this.dataGrid.runnerB.batb.slice().reverse()


      /*

      TO CROSS MATCHING
      // check for cross matching
      const toCrossLayA &#x3D; []
      const toCrossBackA &#x3D; []
      const toCrossLayB &#x3D; []
      const toCrossBackB &#x3D; []
      for(let i&#x3D;0; i &lt; this.dataGrid.runnerA.batb.length;i++){
        if(this.dataGrid.runnerA.batb[i][1]&gt;1){
          toCrossLayA.push([i,this.dataGrid.runnerA.batb[i][1]/(this.dataGrid.runnerA.batb[i][1]-1),this.dataGrid.runnerA.batb[i][2]])
        }
      }

      for(let i&#x3D;0; i &lt; this.dataGrid.runnerA.batl.length;i++){
        if(this.dataGrid.runnerA.batb[i][1]&gt;1){
          toCrossBackA.push([i,this.dataGrid.runnerA.batl[i][1]/(this.dataGrid.runnerA.batl[i][1]-1),this.dataGrid.runnerA.batl[i][2]])
        }
      }

      for(let i&#x3D;0; i &lt; this.dataGrid.runnerB.batb.length;i++){
        if(this.dataGrid.runnerB.batb[i][1]&gt;1){
          toCrossLayB.push([i,this.dataGrid.runnerB.batb[i][1]/(this.dataGrid.runnerB.batb[i][1]-1),this.dataGrid.runnerB.batb[i][2]])
        }
      }
      for(let i&#x3D;0; i &lt; this.dataGrid.runnerB.batl.length;i++){
        if(this.dataGrid.runnerB.batb[i][1]&gt;1){
          toCrossBackB.push([i,this.dataGrid.runnerB.batl[i][1]/(this.dataGrid.runnerB.batl[i][1]-1),this.dataGrid.runnerB.batl[i][2]])
        }
      }

      console.log(toCrossLayA)
      console.log(toCrossBackA)
      console.log(toCrossLayB)
      console.log(toCrossBackB)

       */
    }
  }

  ngOnInit(): void {

    this.setInitialGrid()

    this.populateTimeFrameButtonArray()
    this.createRunnerData()

    this.legend &#x3D;{
      name: &#x27;&#x27;,
      value: [],
      time: null,
      openTime: (new Date(this.market.marketInfo.openDate).getTime()) + (7200 * 1000)
    }


  }

  // tslint:disable-next-line:use-lifecycle-interface
  ngAfterViewInit() {

    this.generateChart()

    // set winner with sec time frame scaled, hide loser
    this.changeTimeFrame(2)
    const loser &#x3D; this.market.marketInfo.winner.id &#x3D;&#x3D;&#x3D; +this.market.marketSelections.runners[0].id ? 1 : 0
    this.changeVisibility(loser,false,true)
    this.fitClick()

    this.chart.subscribeClick((param) &#x3D;&gt; {
      if(this.byClick){
        this.subscriber(param)
      }
    })

    // cross hair suscribe
    this.chart.subscribeCrosshairMove((param) &#x3D;&gt;{
      if(!this.byClick){
        this.subscriber(param)
      }
    });
  }

  subscriber(param) {
    if (param.point) {
      const prevValue &#x3D; this.legend.value
      const prevVol &#x3D; this.legend.volume
      this.legend.value &#x3D; []
      this.legend.volume &#x3D; []
      // valid data point
      this.legend.time &#x3D; param.time * 1000

      for (let i &#x3D; 0; i &lt; this.lineSeriesData.length; i++) {
        const value &#x3D; param.seriesPrices.get(this.lineSeriesData[i]) ? param.seriesPrices.get(this.lineSeriesData[i]) : prevValue[i]
        this.legend.value.push(value)
        const vol &#x3D; param.seriesPrices.get(this.volumeSeriesData[i]) ? param.seriesPrices.get(this.volumeSeriesData[i]) : prevVol[i]
        this.legend.volume.push(vol)
      }
      for (let i &#x3D; 0; i &lt; this.candlestickData.length; i++) {
        const value &#x3D; param.seriesPrices.get(this.candlestickData[i]) ? param.seriesPrices.get(this.candlestickData[i]) : prevValue[i]
        this.legend.value.push(value)
        const vol &#x3D; param.seriesPrices.get(this.volumeSeriesData[i]) ? param.seriesPrices.get(this.volumeSeriesData[i]) : prevVol[i]
        this.legend.volume.push(vol)
      }

    } else {
      return
    }

    // data grid
    this.getBestAvailableByTime()
    this.ladder.countTd(this.market.marketPrices.odds[0].odds, this.market.marketPrices.odds[1].odds, this.legend.time)
    this.ladderData.next([this.ladder.dataA, this.ladder.dataB])
    this.clickTime &#x3D; this.legend.time
  }

  ngOnDestroy(): void {
    this.chart.unsubscribeClick();
    this.chart.unsubscribeCrosshairMove();
  }

  /*
  **
  * MAIN CHART FUNCTIONS
   */

  // plot TV trade in div
  private generateChart() {
    this.tv &#x3D; document.getElementById(&#x27;TVCharts&#x27;) as HTMLElement
    this.chart &#x3D; createChart(this.tv, {
      width: document.getElementById(&#x27;TvContainer&#x27;).clientWidth - 70,
      height: (document.getElementById(&#x27;TvContainer&#x27;).clientWidth - 70) * 0.35,
      localization: {
        locale: &#x27;en-GB&#x27;,
      },
      crosshair: {
        mode: CrosshairMode.Normal,
      },
      rightPriceScale: {
        scaleMargins: {
          top: 0.1,
          bottom: 0.1,
        },
        mode: PriceScaleMode.Logarithmic,
        borderColor: &#x27;rgba(197, 203, 206, 0.4)&#x27;,
        autoScale: true
      },
      layout: {
        backgroundColor: &#x27;#060c17&#x27;,
        textColor: &#x27;#ffffff&#x27;,
      },
      grid: {
        vertLines: {
          color: &#x27;rgba(197, 203, 206, 0.4)&#x27;,
          style: LineStyle.Dotted,
        },
        horzLines: {
          color: &#x27;rgba(197, 203, 206, 0.4)&#x27;,
          style: LineStyle.Dotted,
        },
      },
      watermark: {
        visible: true,
        fontSize: 36,
        horzAlign: &#x27;center&#x27;,
        vertAlign: &#x27;center&#x27;,
        color: &#x27;rgba(171, 71, 188, 0.2)&#x27;,
        text: this.market.marketInfo.name,
      },
      timeScale: {
        visible: true,
        timeVisible: true,
        secondsVisible: true
      }
    });
  }

  // generate runner data from prices
  private createRunnerData() {
    // generate data for all runner
    let firstColor &#x3D; &#x27;#c86f6f&#x27;
    let i &#x3D; 0
    for (const odd of this.market.marketPrices.odds) {

      // increment the color for each runner
      firstColor &#x3D; incrementColor(firstColor, 5000)

      // initialize runner data
      const tempRunner: RunnerDataAdvanced &#x3D; {
        runnerId: odd.runnerId,
        data: [],
        volume: [],
        color: firstColor,
        name: this.market.marketSelections.runners[i].name,
        visible: true
      }

      // add odds for this runner
      let previousVol &#x3D; 0
      for (const o of odd.odds) {
        const time: number &#x3D; +o.timestamp / 1000
        const tempOdds &#x3D; {
          time,
          value: o.ltp,
        }
        const tempVol &#x3D; {
          time,
          value: o.tv - previousVol,
        }
        previousVol &#x3D; o.tv

        if (o.ltp &gt; 1) {
          tempRunner.data.push(tempOdds)
          tempRunner.volume.push(tempVol)
        }

      }
      // add this runner to list of data
      this.runnersData.push(tempRunner)
      i++
    }
  }

  /*
  **
  * SET DATA IN CHARTS FUNCTIONS
   */

  // set line series in charts
  private setLineSeriesInCharts() {
    // for runner create their TvData and append their odds
    // tslint:disable-next-line:forin
    for (let i &#x3D; 0; i &lt; this.runnersData.length; i++) {
      // this runner series
      const runnerSeries &#x3D; this.chart.addLineSeries({
        title: this.market.marketSelections.runners[i].name,
      });
      runnerSeries.setData(this.runnersData[i].data);

      // series options
      runnerSeries.applyOptions({
        priceLineVisible: false,
        color: this.runnersData[i].color,
        priceLineColor: this.runnersData[i].color,
        lastValueVisible: false,
        visible: this.runnersData[i].visible,
      });

      // set line and dots
      this.setLineAndInPlayDots(runnerSeries, i)

      // pusdh in DATA
      this.lineSeriesData.push(runnerSeries)
      // add volume for this runner
      this.setVolumeSeriesToChart(i, null)
    }
  }

  // set volume in charts
  private setVolumeSeriesToChart(index: number, volData: any) {
    // VOLUME

    const runnerSeriesVolume &#x3D; this.chart.addHistogramSeries({
      color: this.runnersData[index].color,
      priceFormat: {
        type: &#x27;volume&#x27;,
      },
      priceScaleId: &#x27;&#x27;,
      scaleMargins: {
        top: 0.8,
        bottom: 0,
      },
      lastValueVisible: false,
    });
    if (volData) {
      runnerSeriesVolume.setData(volData);
    } else {
      runnerSeriesVolume.setData(this.runnersData[index].volume);
    }

    if (!(this.runnersData[index].visible)) {
      runnerSeriesVolume.applyOptions({
        visible: status,
      });
    }

    this.volumeSeriesData.push(runnerSeriesVolume)
  }

  private setLineAndInPlayDots(runnerSeries: any, i: number) {
    // create line for limit 1
    runnerSeries.createPriceLine({
      price: 1,
      color: &#x27;#919191&#x27;,
      lineWidth: 2,
      lineStyle: LineStyle.Dotted,
      axisLabelVisible: false,
    });
    // create line for odds 2
    runnerSeries.createPriceLine({
      price: 2,
      color: &#x27;#ffbdbd&#x27;,
      lineWidth: 2,
      lineStyle: LineStyle.SparseDotted,
      axisLabelVisible: false,
    });
    // set time markers
    if (this.market.marketInfo.sport &#x3D;&#x3D;&#x3D; &#x27;FOOTBALL&#x27;) {
      runnerSeries.setMarkers([
        // inPlay
        {
          time: (this.market.marketUpdates.updates.inPlay + 7200000) / 1000,
          position: &#x27;inBar&#x27;,
          color: &#x27;yellow&#x27;,
          shape: &#x27;circle&#x27;,
          size: 2,
          id: &#x27;inplay Runner&#x27; + i,
        },
        // start half time
        {
          time: (this.market.marketUpdates.updates.inPlay + 7200000 + 2700000) / 1000 + 7200,
          position: &#x27;inBar&#x27;,
          color: &#x27;red&#x27;,
          shape: &#x27;circle&#x27;,
          id: &#x27;startHalfTime Runner&#x27; + i,
        },
        // end half time
        {
          time: (this.market.marketUpdates.updates.inPlay + 7200000 + 2700000 + 900000) / 1000 + 7200,
          position: &#x27;inBar&#x27;,
          color: &#x27;blu&#x27;,
          shape: &#x27;circle&#x27;,
          id: &#x27;endHalfTime Runner&#x27; + i,
        },
      ]);
    } else {
      runnerSeries.setMarkers([
        // in play
        {
          time: (this.market.marketUpdates.updates.inPlay + 7200000) / 1000,
          position: &#x27;inBar&#x27;,
          color: &#x27;yellow&#x27;,
          size: 2,
          shape: &#x27;circle&#x27;,
          id: &#x27;inplay Runner&#x27; + i,
        },
      ]);
    }
  }


  /*
  **
  * CLICK AND OTHER FUNCTIONS
   */

  // support function to change runner by button
  public changeRunnerState(runnerId: string) {

    let i &#x3D; 0
    for (const runner of this.runnersData) {
      if (runnerId &#x3D;&#x3D;&#x3D; runner.runnerId) {
        if (runner.visible &#x3D;&#x3D;&#x3D; true) {
          if (this.lineSeriesData.length) {
            this.changeVisibility(i, false, false)
          } else if (this.candlestickData.length) {
            this.changeVisibility(i, false, true)
          }
          break
        } else {
          if (this.lineSeriesData.length) {
            this.changeVisibility(i, true, false)
          } else if (this.candlestickData.length) {
            this.changeVisibility(i, true, true)
          }
          break
        }
      }
      i++
    }
  };

  // expand chart click
  public fitClick() {
    this.chart.timeScale().resetTimeScale();
    this.chart.timeScale().fitContent();
  }

  // prematch only click
  public preMatchOnlyClick() {


    this.chart.timeScale().setVisibleRange({
      from: (this.market.marketUpdates.updates.open + (3600000)) / 1000,
      to: (this.market.marketUpdates.updates.inPlay) / 1000,
    })
  }

  // go to inPlay click
  public goToInPlayClick() {
    this.chart.timeScale().setVisibleRange({
      from: (this.market.marketUpdates.updates.inPlay) / 1000,
      to: (this.market.marketUpdates.updates.closed + (3600000)) / 1000,
    })
  }


  /*
  **
  *  TIME FRAME
   */


  // change the visibility for the runner in this position
  private changeVisibility(runnerPos: number, status: boolean, isCandle: boolean) {
    this.runnersData[runnerPos].visible &#x3D; status
    // volume
    this.volumeSeriesData[runnerPos].applyOptions({
      visible: status,
    });
    // odds
    if (!isCandle) {
      this.lineSeriesData[runnerPos].applyOptions({
        visible: status,
      });
    } else {
      this.candlestickData[runnerPos].applyOptions({
        visible: status,
      });
    }
  }

  // populate the array with static data
  private populateTimeFrameButtonArray() {
    this.timeFrameState.push({
      state: false,
      name: &#x27;Line&#x27;,
      color: &#x27;withe&#x27;
    })
    this.timeFrameState.push({
      state: false,
      name: &#x27;10 S&#x27;,
      color: &#x27;yellow&#x27;
    })
    this.timeFrameState.push({
      state: true,
      name: &#x27;20 S&#x27;,
      color: &#x27;yellow&#x27;
    })
    this.timeFrameState.push({
      state: false,
      name: &#x27;30 S&#x27;,
      color: &#x27;yellow&#x27;
    })
    this.timeFrameState.push({
      state: false,
      name: &#x27;1M&#x27;,
      color: &#x27;green&#x27;
    })
    this.timeFrameState.push({
      state: false,
      name: &#x27;3M&#x27;,
      color: &#x27;green&#x27;
    })
    this.timeFrameState.push({
      state: false,
      name: &#x27;5M&#x27;,
      color: &#x27;green&#x27;
    })
    this.timeFrameState.push({
      state: false,
      name: &#x27;10M&#x27;,
      color: &#x27;grey&#x27;
    })
    this.timeFrameState.push({
      state: false,
      name: &#x27;30M&#x27;,
      color: &#x27;grey&#x27;
    })
  }

  // click that update button and start the switch
  changeTimeFrameClick(index: number) {
    for (const time of this.timeFrameState) {
      time.state &#x3D; false
    }
    this.timeFrameState[index].state &#x3D; true
    this.changeTimeFrame(index)
  }

  // main functions that reset chart and generate new value via switch
  public changeTimeFrame(index: number) {

    // remove all data from charts
    if (this.lineSeriesData.length) {
      this.removeAllLineSeries()
    }
    this.removeAllVolumeSeries()
    if (this.candlestickData.length) {
      this.removeAllCandleSeries()
    }

    if(index&#x3D;&#x3D;&#x3D;0){
      this.setLineSeriesInCharts()

    } else {
      for (let i &#x3D; 0; i &lt; this.runnersData.length; i++) {
        const run &#x3D; JSON.parse(JSON.stringify(this.runnersData[i]));

        switch (index) {
          case (1): {
            const newData &#x3D; this.generateCandlestickByDuration(10, run.data, run.volume)
            this.setNewCandleTimeFrame(newData[0], newData[1], i)
            break
          }
          case (2): {
            const newData &#x3D; this.generateCandlestickByDuration(20, run.data, run.volume)
            this.setNewCandleTimeFrame(newData[0], newData[1], i)
            break
          }
          case (3): {
            const newData &#x3D; this.generateCandlestickByDuration(30, run.data, run.volume)
            this.setNewCandleTimeFrame(newData[0], newData[1], i)
            break
          }
          case (4): {
            const newData &#x3D; this.generateCandlestickByDuration(60, run.data, run.volume)
            this.setNewCandleTimeFrame(newData[0], newData[1], i)
            break
          }
          case (5): {
            const newData &#x3D; this.generateCandlestickByDuration(180, run.data, run.volume)
            this.setNewCandleTimeFrame(newData[0], newData[1], i)
            break
          }
          case (6): {
            const newData &#x3D; this.generateCandlestickByDuration(300, run.data, run.volume)
            this.setNewCandleTimeFrame(newData[0], newData[1], i)
            break
          }
          case (7): {
            const newData &#x3D; this.generateCandlestickByDuration(600, run.data, run.volume)
            this.setNewCandleTimeFrame(newData[0], newData[1], i)
            break
          }
          case (8): {
            const newData &#x3D; this.generateCandlestickByDuration(1800, run.data, run.volume)
            this.setNewCandleTimeFrame(newData[0], newData[1], i)
            break
          }
        }
      }
    }
  }


  // set new candlestick time frame in the carts
  private setNewCandleTimeFrame(odds: any[], vol: any[], index: number) {

    // create candlestick
    const candlestickSeries &#x3D; this.chart.addCandlestickSeries();
    candlestickSeries.setData(odds)
    candlestickSeries.applyOptions({
      priceLineVisible: false,
      lastValueVisible: false,
    })


    // check for visibility
    if (!(this.runnersData[index].visible)) {
      candlestickSeries.applyOptions({
        visible: status,
      });
    }

    // set line and dots
    this.setLineAndInPlayDots(candlestickSeries, index)
    // push in data
    this.candlestickData.push(candlestickSeries)

    // volume
    this.setVolumeSeriesToChart(index, vol)

  }

  // return the new data for [odds, volume] with the new timeframe
  private generateCandlestickByDuration(secDuration: number, odds: any[], volume: any[]): any[] {

    const responseOdds &#x3D; []
    const responseVol &#x3D; []
    let timeDelta &#x3D; 0
    // first set
    let tempCandle &#x3D; {
      time: odds[0].time,
      open: odds[0].value,
      high: odds[0].value,
      low: odds[0].value,
      close: odds[0].value,
    }
    // volume
    let volDelta &#x3D; 0

    for (let i &#x3D; 1; i &lt; odds.length - 2; i++) {
      // check if add
      timeDelta &#x3D; (odds[i].time) - tempCandle.time

      if (timeDelta &gt; secDuration) {
        // VOLUME -------
        // push in array vol
        // add this vol
        volDelta &#x3D; volDelta + (volume[i].value)
        responseVol.push({
          time: tempCandle.time,
          value: volDelta
        })
        // reset vol
        volDelta &#x3D; volume[i + 1].value

        // ODDS -----
        // push in array odds
        tempCandle.close &#x3D; odds[i].value
        responseOdds.push(tempCandle)
        // reset value
        tempCandle &#x3D; {
          time: odds[i + 1].time,
          open: odds[i + 1].value,
          high: odds[i + 1].value,
          low: odds[i + 1].value,
          close: odds[i + 1].value,
        }
        i &#x3D; i + 2

      } else {

        // check for max / min
        if (odds[i].value &gt; tempCandle.high) {
          tempCandle.high &#x3D; odds[i].value
        }
        if (odds[i].value &lt; tempCandle.low) {
          tempCandle.low &#x3D; odds[i].value
        }

        // add volume
        volDelta &#x3D; volDelta + (volume[i].value)
      }
    }

    // set the last value for all time frame
    responseOdds[responseOdds.length-1].close &#x3D; odds[odds.length-1].value
    return [responseOdds, responseVol]
  }

  /*
  **
  *  UTILS
   */
  private removeAllLineSeries() {
    // empty chart already present
    // tslint:disable-next-line:prefer-for-of
    for (let i &#x3D; 0; i &lt; this.lineSeriesData.length; i++) {
      this.chart.removeSeries(this.lineSeriesData[i])
    }
    this.lineSeriesData &#x3D; []
  }

  private removeAllVolumeSeries() {
    // empty chart already present
    // tslint:disable-next-line:prefer-for-of
    for (let i &#x3D; 0; i &lt; this.volumeSeriesData.length; i++) {
      this.chart.removeSeries(this.volumeSeriesData[i])
    }
    this.volumeSeriesData &#x3D; []
  }

  private removeAllCandleSeries() {
    // empty chart already present
    // tslint:disable-next-line:prefer-for-of
    for (let i &#x3D; 0; i &lt; this.candlestickData.length; i++) {
      this.chart.removeSeries(this.candlestickData[i])
    }
    this.candlestickData &#x3D; []
  }

  /*
  **
  *  LEGEND
   */

  totalVolume(runnerIndex: number){

    let total &#x3D;0

    // tslint:disable-next-line:prefer-for-of
    for (let i&#x3D;0;i&lt;this.runnersData[runnerIndex].volume.length;i++){
      if(this.runnersData[runnerIndex].volume[i].time*1000 &gt; this.legend.time){
        i &#x3D; 100000000000
      } else {
        total +&#x3D; this.runnersData[runnerIndex].volume[i].value
      }
    }

    if(total&lt;1000000){
      return &#x60;${Math.round(total /1000)}K&#x60;
    } else {
      return &#x60;${Math.round((total /1000000)*1000)/1000}M&#x60;
    }


  }
}


// increment the color function
export function incrementColor(color, step){
  // tslint:disable-next-line:one-variable-per-declaration
  let colorToInt &#x3D; parseInt(color.substr(1), 16),
    nStep &#x3D; parseInt(step);
  if(!isNaN(colorToInt) &amp;&amp; !isNaN(nStep)){
    colorToInt +&#x3D; nStep;
    let nColor &#x3D; colorToInt.toString(16);
    nColor &#x3D; &#x27;#&#x27; + (new Array(7-nColor.length).join(&#x27;0&#x27;)) + nColor;
    if(/^#[0-9a-f]{6}$/i.test(nColor)){
      return nColor;
    }
  }
  return color;
}


</code></pre>
    </div>
</div>







                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'interface';
            var COMPODOC_CURRENT_PAGE_URL = 'RunnerDataAdvanced.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>

       <script src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
